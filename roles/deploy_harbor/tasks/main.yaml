- name: Install pip package manager on remote node
  package:
    name: python3-pip
    state: present
  become: true

- name: Install pre-requisites on remote node for K8s ops
  pip:
    name:
      - openshift
      - pyyaml
      - kubernetes

- name: Get redis service cluster ip
  kubernetes.core.k8s_info:
    kind: Service
    name: redis-master
    namespace: "{{ harbor_namespace }}"
  register: redis_service

- name: Check redis service IP
  fail:
    msg: "Redis service IP not found"
  when: redis_service.resources[0].spec.clusterIP is not defined

- name: Add stable harbor helm chart repo
  kubernetes.core.helm_repository:
    name: harbor
    repo_url: https://helm.goharbor.io

- name: Create the harbor namespace
  kubernetes.core.k8s:
    name: "{{ harbor_namespace }}"
    kind: Namespace
    state: present

- name: Read in Openstack auth credentials
  include_vars:
    file: "{{ inventory_dir + '/credentials/clouds.yaml' }}"
    name: openstack_credentials

- name: Deploy harbor
  kubernetes.core.helm:
    chart_ref: harbor/harbor
    create_namespace: yes
    update_repo_cache: yes
    # Pulled from default
    name: "harbor"
    release_namespace: "{{ harbor_namespace }}"
    values:
      expose:
        type: ingress
        tls:
          enabled: true
          certSource: "auto"
          commonName: "{{ harbor_domain }}"
